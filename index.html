<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>LogÃ­stica - Viajes con IVA PRO</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --blue: #2563eb; --dark: #0f172a; --bg: #f8fafc; --border: #e2e8f0; --green: #16a34a; --red: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        #bloqueo { position: fixed; inset: 0; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; flex-direction: column; }
        .pin-input { padding: 15px; font-size: 24px; text-align: center; border-radius: 8px; border: none; width: 200px; margin-top: 15px; background: #1e293b; color: white; letter-spacing: 5px; }
        #side { width: 250px; background: var(--dark); color: white; display: flex; flex-direction: column; flex-shrink: 0; }
        #main { flex-grow: 1; padding: 25px; overflow-y: auto; }
        #calc { width: 350px; background: white; border-left: 1px solid var(--border); padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-weight: bold; color: #60a5fa; text-align: center; border-bottom: 1px solid #1e293b; font-size: 20px; }
        .chofer-item { padding: 15px; margin: 5px 10px; background: #1e293b; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .chofer-item:hover, .chofer-item.active { background: var(--blue); }
        .card { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        .field label { font-size: 11px; font-weight: bold; color: #64748b; text-transform: uppercase; }
        .field input, .field select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th { background: #f1f5f9; padding: 12px; border-bottom: 2px solid var(--border); font-size: 12px; color: #475569; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 13px; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-green { background: var(--green); color: white; }
        .btn-gray { background: #64748b; color: white; }
        .resumen-box { background: #f8fafc; border: 1px solid var(--border); padding: 15px; border-radius: 10px; margin-top: 10px; }
        .resumen-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #cbd5e1; font-size: 13px; }
        .total-pago { font-size: 24px; color: var(--blue); font-weight: bold; text-align: center; margin: 15px 0; }
        @media print { .no-print { display: none !important; } #main { padding: 0; } body { background: white; } .card { box-shadow: none; border: 1px solid #eee; } }
    </style>
</head>
<body>

<div id="bloqueo">
    <h1 style="letter-spacing: 3px;">VIAJES CON IVA</h1>
    <p>Control de LogÃ­stica - Acceso Privado</p>
    <input type="password" id="passInput" class="pin-input" placeholder="****">
    <button onclick="verificar()" class="btn btn-green" style="margin-top:20px; width:200px;">INGRESAR</button>
</div>

<div id="appBody" style="display: none; width: 100%; height: 100%;">
    <div id="side" class="no-print">
        <div class="brand">MASTER LOG</div>
        <div id="listaChoferes" style="flex: 1; overflow-y: auto;"></div>
        <div style="padding: 15px; border-top: 1px solid #1e293b;">
            <button class="btn btn-green" style="width:100%" onclick="nuevoChofer()">+ NUEVO CHOFER</button>
        </div>
    </div>

    <div id="main">
        <div id="secChofer" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1 id="txtNombre" style="margin:0; color:var(--dark);"></h1>
                <div class="no-print">
                    <button class="btn btn-gray" onclick="window.print()">ðŸ“„ GENERAR PDF / IMPRIMIR</button>
                    <button class="btn" style="background:var(--red); color:white;" onclick="borrarChofer()">Eliminar Chofer</button>
                </div>
            </div>
            
            <div class="card no-print">
                <div class="grid-inputs">
                    <div class="field"><label>Fecha</label><input type="date" id="fFecha"></div>
                    <div class="field"><label>Detalle / Ruta</label><input type="text" id="fDetalle"></div>
                    <div class="field"><label>Tipo Registro</label>
                        <select id="fTipo">
                            <option value="Carga">VIAJE (Con IVA)</option>
                            <option value="Adelanto">ADELANTO ($)</option>
                            <option value="Gasoil">GASOIL ($)</option>
                        </select>
                    </div>
                </div>
                <div class="grid-inputs">
                    <div class="field"><label>Toneladas (TN)</label><input type="number" id="fTn" step="0.01"></div>
                    <div class="field"><label>Tarifa ($)</label><input type="number" id="fTarifa"></div>
                    <div class="field"><label>ComisiÃ³n %</label><input type="number" id="fComi" value="0"></div>
                    <button class="btn btn-green" style="align-self: flex-end;" onclick="guardar()">GUARDAR REGISTRO</button>
                </div>
            </div>

            <div class="card" style="padding:0; overflow: hidden;">
                <table>
                    <thead>
                        <tr>
                            <th class="no-print">Sel</th>
                            <th>Fecha</th>
                            <th>Detalle</th>
                            <th>TN</th>
                            <th>Tarifa</th>
                            <th>Neto</th>
                            <th>IVA (21%)</th>
                            <th>Total</th>
                            <th class="no-print">AcciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody id="tablaViajes"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="calc" class="no-print">
        <h3 style="text-align:center; margin-top:0;">RESUMEN MENSUAL</h3>
        <div class="resumen-box">
            <div class="resumen-item"><span>Total Viajes:</span> <span id="resViajes">$ 0</span></div>
            <div class="resumen-item"><span>Total Adelantos:</span> <span id="resAdelantos" style="color:var(--red)">$ 0</span></div>
            <div class="resumen-item"><span>Total Gasoil:</span> <span id="resGasoil" style="color:var(--red)">$ 0</span></div>
            <hr>
            <div class="resumen-item" style="font-weight:bold; font-size:16px;"><span>SALDO TOTAL:</span> <span id="resSaldo">$ 0</span></div>
        </div>
        
        <h3 style="text-align:center; margin-top:30px;">LIQUIDAR AHORA</h3>
        <p style="font-size:11px; text-align:center; color:#64748b;">SeleccionÃ¡ filas de la tabla para sumar</p>
        <div class="total-pago" id="valPago">$ 0</div>
        <div id="liqcuerpo" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px;"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCLBvSUo8NemdYL_zgP0Fo-tg8aLiggqgQ",
        authDomain: "viajes-con-iva.firebaseapp.com",
        databaseURL: "https://viajes-con-iva-default-rtdb.firebaseio.com",
        projectId: "viajes-con-iva",
        storageBucket: "viajes-con-iva.firebasestorage.app",
        messagingSenderId: "659354481888",
        appId: "1:659354481888:web:faec78a76d6fcb674d4c85"
    };

    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('logistica_viva_pro');
    let db = { choferes: [] };
    let act = null;

    dbRef.on('value', (s) => { 
        if(s.val()) { 
            db = s.val(); 
            renderLista(); 
            if(act !== null) renderTabla(); 
        } 
    });

    function verificar() { if(document.getElementById('passInput').value === "1234") { document.getElementById('bloqueo').style.display='none'; document.getElementById('appBody').style.display='flex'; } else { alert("Clave Incorrecta"); } }
    function salvar() { dbRef.set(db); }

    function nuevoChofer() { 
        let n = prompt("Nombre completo del Chofer:"); 
        if(n) { 
            if(!db.choferes) db.choferes = []; 
            db.choferes.push({ nombre: n.toUpperCase(), viajes: [] }); 
            salvar(); 
        } 
    }

    function seleccionar(i) { 
        act = i; 
        document.getElementById('secChofer').style.display='block'; 
        document.getElementById('txtNombre').innerText = db.choferes[i].nombre; 
        renderTabla(); 
        renderLista(); 
    }

    function guardar() {
        if(act === null) return;
        let tipo = document.getElementById('fTipo').value;
        let f = document.getElementById('fFecha').value;
        let d = document.getElementById('fDetalle').value || '-';
        
        let neto = 0, iva = 0, total = 0, tn = 0, tr = 0, co = 0;

        if(tipo === 'Carga') {
            tn = parseFloat(document.getElementById('fTn').value) || 0;
            tr = parseFloat(document.getElementById('fTarifa').value) || 0;
            co = parseFloat(document.getElementById('fComi').value) || 0;
            neto = (tn * tr) * (1 - (co/100));
            iva = neto * 0.21;
            total = neto + iva;
        } else {
            total = parseFloat(prompt("Ingrese el monto del " + tipo + ":")) || 0;
        }

        if(!db.choferes[act].viajes) db.choferes[act].viajes = [];
        db.choferes[act].viajes.push({ fecha: f, detalle: d, tipo, tn, tarifa: tr, comi: co, neto, iva, total });
        salvar();
        ['fDetalle','fTn','fTarifa','fComi'].forEach(id => document.getElementById(id).value = '');
    }

    function renderTabla() {
        let b = document.getElementById('tablaViajes'); b.innerHTML = '';
        let sViajes = 0, sAdelantos = 0, sGasoil = 0;
        
        if(!db.choferes[act].viajes) db.choferes[act].viajes = [];
        
        db.choferes[act].viajes.forEach((v, i) => {
            if(v.tipo === 'Carga') sViajes += v.total;
            else if(v.tipo === 'Adelanto') sAdelantos += v.total;
            else if(v.tipo === 'Gasoil') sGasoil += v.total;

            b.innerHTML += `<tr>
                <td class="no-print"><input type="checkbox" class="chk" data-idx="${i}" onchange="calcPago()"></td>
                <td>${v.fecha}</td>
                <td style="text-align:left">${v.tipo !== 'Carga' ? '<b>['+v.tipo+']</b> ' : ''}${v.detalle}</td>
                <td>${v.tn || '-'}</td>
                <td>${v.tarifa ? '$'+v.tarifa.toLocaleString() : '-'}</td>
                <td>$${Math.round(v.neto).toLocaleString()}</td>
                <td>$${Math.round(v.iva).toLocaleString()}</td>
                <td style="font-weight:bold">$${Math.round(v.total).toLocaleString()}</td>
                <td class="no-print"><button onclick="borrarViaje(${i})" style="color:red; border:none; background:none; cursor:pointer;">âœ–</button></td>
            </tr>`;
        });

        document.getElementById('resViajes').innerText = '$ ' + Math.round(sViajes).toLocaleString();
        document.getElementById('resAdelantos').innerText = '$ ' + Math.round(sAdelantos).toLocaleString();
        document.getElementById('resGasoil').innerText = '$ ' + Math.round(sGasoil).toLocaleString();
        document.getElementById('resSaldo').innerText = '$ ' + Math.round(sViajes - sAdelantos - sGasoil).toLocaleString();
        calcPago();
    }

    function calcPago() {
        let t = 0; let c = document.getElementById('liqcuerpo'); c.innerHTML = '';
        document.querySelectorAll('.chk:checked').forEach(chk => {
            let v = db.choferes[act].viajes[chk.dataset.idx];
            let val = (v.tipo === 'Carga') ? v.total : -v.total;
            t += val;
            c.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                <span>${v.detalle}</span> <b>$${Math.round(val).toLocaleString()}</b>
            </div>`;
        });
        document.getElementById('valPago').innerText = `$ ${Math.round(t).toLocaleString()}`;
    }

    function renderLista() {
        let l = document.getElementById('listaChoferes'); l.innerHTML = '';
        if(!db.choferes) return;
        db.choferes.forEach((c, i) => {
            l.innerHTML += `<div class="chofer-item ${act === i ? 'active' : ''}" onclick="seleccionar(${i})">${c.nombre}</div>`;
        });
    }

    function borrarViaje(i) { if(confirm("Â¿Eliminar este registro?")) { db.choferes[act].viajes.splice(i,1); salvar(); } }
    function borrarChofer() { if(confirm("Â¿ELIMINAR TODO EL CHOFER Y SUS DATOS?")) { db.choferes.splice(act,1); act=null; document.getElementById('secChofer').style.display='none'; salvar(); } }
</script>
</body>
</html>
